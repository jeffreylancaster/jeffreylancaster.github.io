<!DOCTYPE html>
<html>
<!-- from: https://bl.ocks.org/Andrew-Reid/0aedd5f3fb8b099e3e10690bd38bd458 -->
  <head>
    <title>Stranger Things: Co-stars</title>
    <meta charset="UTF-8">
    <meta name="description" content="Stranger Things: Co-stars">
    <meta name="keywords" content="Stranger Things, data visualization, narrative chart, Eleven, Jim Hopper, Mike Wheeler, Dustin Henderson, Lucas Sinclair, Will Byers, Jonathan Byers, Nancy Wheeler">
    <meta name="author" content="Jeffrey Lancaster">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css" />
    <style>
      body{
        font-family: "Helvetica Neue";
        padding-top: 35px;
      }
      header{
        margin: 15px;
      }
      header img{
        height: 120px;
        vertical-align: middle;
        margin-top: -50px;
      }
      header span{
        font-weight: 300;
        font-size: 50px;
      }
      #cta{
        color: #999;
        font-style: italic;
        font-size: 0.8em;
      }
      #description{
        width: 100%;
        max-width: 1000px;
        margin: 0 15px;
        color: #999;
        font-size: 0.8em;
      }
      #description a{
        text-decoration: none;
      }
      #list{
        margin: 0 30px 30px;
        color: #999;
        font-weight: 400;
        line-height: 1.4em;
        font-size: 0.9em;
      }
      #list a{
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>
        <img src="../img/Stranger-Things_logo.png">
        <span> - Co-stars</span>
      </h1>
    </header>
    <div id="description">
      <p>Code for this list is on <a href="https://github.com/jeffreylancaster/stranger-things" target="_blank">github</a>, and a description of the project is on <a href="https://medium.com/@jeffrey.lancaster/the-ultimate-game-of-thrones-dataset-a100c0cf35fb" target="_blank">Medium</a>. Comments and suggestions are welcome on github, Medium, or <a href="mailto: jeffrey@jeffreylancaster.com" target="_blank">here</a>.</p>
    </div>
    <div id="list"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    
    <script>

/* HELPFUL FUNCTIONS */

// to convert scene start/end times into seconds
/* function sec(timeString){
  var sec = 0;
  if (timeString.length == 0) return sec;
  var splitArray = timeString.split(":");
  sec = 3600*parseFloat(splitArray[0])+60*parseFloat(splitArray[1])+parseFloat(splitArray[2]);
  return sec;
} */

// to convert seconds into hh:mm:ss
/* function secondsToHMS(d) {
  var date = new Date(null);
  date.setSeconds(d); // specify value for SECONDS here
  return date.toISOString().substr(11, 8);
} */

// to dedpulicate an array
 function onlyUnique(value, index, self) { 
  return self.indexOf(value) === index;
}

// async forEach
// from: https://codeburst.io/javascript-async-await-with-foreach-b6ba62bbf404
async function asyncForEach(array, callback) {
  for (let index = 0; index < array.length; index++) {
    await callback(array[index], index, array);
  }
}
// from: https://staxmanade.com/2016/07/easily-simulate-slow-async-calls-using-javascript-async-await/
async function stall(stallTime = 3000) {
  await new Promise(resolve => setTimeout(resolve, stallTime));
}


/* VARIABLES AND CONFIGURATION */

var config = {
  getAPI: false,
  cutoff: 2
}
var films = {};
var filmsArray = [];
var costars = {};

// variable containers for imported data
var charactersData,
  locationsData,
  locationsAltData,
  episodesData,
  charactersIncludeData,
  charactersGenderData,
  keyValue,
  keyValuesFile,
  episodeLengths,
  locations,
  subLocations,
  group,
  colors,
  env,
  costarsData;


/* IMPORT DATA */
$.when(
  $.getJSON("../data/characters.json", function(data) {
    charactersData = data.characters;
    console.log("characters.json loaded");
  })
  .fail(function() {console.error("characters.json not loaded");}),
      
  // $.getJSON("../data/locations.json", function(data) {
  //   locationsData = data.regions;
  //   console.log("locations.json loaded");
  // })
  // .fail(function() {console.error("locations.json not loaded");}),

  // $.getJSON("../data/locations-alt.json", function(data) {
  //   locationsAltData = data.sceneLocSorted;
  //   console.log("locations-alt.json loaded");
  // })
  // .fail(function() {console.error("locations-alt.json not loaded");}),

  // $.getJSON("../data/episodes.json", function(data) {
  //   episodesData = data.episodes;
  //   console.log("episodes.json loaded");
  // })
  // .fail(function() {console.error("episodes.json not loaded");}),

  // $.getJSON("../data/characters-include.json", function(data) {
  //   charactersIncludeData = data.include;
  //   console.log("characters-include.json loaded");
  // })
  // .fail(function() {console.error("characters-include.json not loaded");}),

  // $.getJSON("../data/characters-gender.json", function(data) {
  //   charactersGenderData = data.gender;
  //   console.log("characters-gender.json loaded");
  // })
  // .fail(function() {console.error("characters-gender.json not loaded");}),

  // $.getJSON("../data/keyValues.json", function(data) {
  //   keyValues = data.keyValues;
  // episodeLengths = data.episodeLengths;
  //   locations = data.sceneLocSorted;
  //   subLocations = data.sceneSubLocSorted;
  //   console.log("keyValues.json loaded");
  // })
  // .fail(function() {console.error("keyValues.json not loaded");}),

  // $.getJSON("../data/characters-groups.json", function(data) {
  //   group = data.groups;
  //   console.log("characters-groups.json loaded");
  // })
  // .fail(function() {console.error("characters-groups.json not loaded");}),

  // $.getJSON("../data/colors.json", function(data) {
  //   colors = data.colors;
  //   console.log("colors.json loaded");
  // })
  // .fail(function() {console.error("colors.json not loaded");}),

  $.getJSON("../env.json", function(data) {
    env = data.env;
    console.log("env.json loaded");
  })
  .fail(function() {console.error("env.json not loaded");}),

  $.getJSON("../data/costars.json", function(data) {
    costarsData = data;
    console.log("costars.json loaded");
  })
  .fail(function() {console.error("costars.json not loaded");})


/* DO STUFF WITH THE DATA */

).then(function() {
  console.log("now that the files are loaded... do magic.");

  var characters = {};
  var charactersObj = {};

  // parse actorLink to just nm####### into array of objects with characterName and actorName.
  for(var i in charactersData){
    if(charactersData[i].actors){
      $.each(charactersData[i].actors, function(j, val){
        characters[val.actorLink.split("/")[2]] = {
          "actorLink": val.actorLink.split("/")[2],
          "characterName": charactersData[i].characterName,
          "actorName": val.actorName
        };
      });
    }
    if(charactersData[i].actorLink){
      characters[charactersData[i].actorLink.split("/")[2]] = {
        "actorLink": charactersData[i].actorLink.split("/")[2],
        "characterName": charactersData[i].characterName,
        "actorName": charactersData[i].actorName
      };
    }
  }

  if(config.getAPI){

    const themoviedbLookup = async () => {
      try{
        await asyncForEach(Object.keys(characters), async (id) => {
          await themoviedbGetActorID(id);
          console.log(id);
        });
        console.log('Done');
        $("#list").html(JSON.stringify(costars));
      } catch(err){
        console.log(err);
      }
    }

    const themoviedbGetActorID = async (imdbID) => {
      await stall(250); // stalls for 1/4 a second
      const actorData = await $.ajax({
          url: "https://api.themoviedb.org/3/find/"+imdbID,
          data: {
            api_key: env.themoviedb,
            language: "en-US",
            external_source: "imdb_id"
          }
      });
      // add to costars
      if(actorData.person_results.length > 0 && actorData.person_results[0].id){
        costars[actorData.person_results[0].id] = {
          name: actorData.person_results[0].name
        };
        const moreData = await themoviedbGetFilms(actorData.person_results[0].id);
        // console.log(moreData);
        return moreData;
      } else {
        // console.log(actorData);
        return actorData;
      }
    }
    
    const themoviedbGetFilms = async (actorID) => {
      await stall(100); // stalls for 1/10 a second
      const filmsResult = await $.ajax({
          url: "https://api.themoviedb.org/3/person/"+actorID+"/movie_credits",
          data: {
            api_key: env.themoviedb,
            language: "en-US"
          }
        });
      if (filmsResult.cast.length > 0) {
        // add to costars
        console.log(filmsResult.cast);
        $.each(filmsResult.cast, function(j,val){
          // if film entry exists, add to actors
          if(costars[val.id]){
            costars[val.id].actors[filmsResult.id] = {
              //id: filmsResult.id,
              character: val.character
            };
          }
          // otherwise, create a new entry and add to actors
          else {
            var release_date = "";
            if(val.release_date){
              release_date = val.release_date.split("-")[0];
            }
            costars[val.id] = {
              actors: {},
              title: val.title,
              //id: val.id,
              release_date: release_date
            };
            costars[val.id].actors[filmsResult.id] = {
              //id: filmsResult.id,
              character: val.character
            }
          }
        });
        await asyncForEach(filmsResult.cast, async (id) => {
          await imdbFilmData(id);
          //console.log(id);
        });
        console.log('Done');
        // console.log(filmsResult);
        return imdbFilmData;
      } else {
        // console.log(filmsResult);
        return filmsResult;
      }
    }

    const imdbFilmData = async (themoviedbID) => {
      if(themoviedbID.id){
        await stall(200); // stalls for 1/5 a second
        const idResult = await $.ajax({
            url: "https://api.themoviedb.org/3/movie/"+themoviedbID.id+"/external_ids",
            data: {
              api_key: env.themoviedb
            }
          });
        if (idResult.imdb_id) {
          costars[idResult.id].imdb_id = idResult.imdb_id
          // console.log(idResult);
          return idResult;
        } else {
          // console.log(idResult);
          return idResult;
        }
      }
    }

    themoviedbLookup();

  } else {
    costars = costarsData;
  }

  for(var i in costars){
    if(costars[i].actors && Object.keys(costars[i].actors).length >= config.cutoff){
      filmsArray.push(costars[i]);
      for(var j in costars[i].actors){
        costars[i].actors[j].actor = costars[j].name;
        costars[i].actors[j].id = j;
      }
    }
  }

  // align costars with characters to add Stranger Things characterName
  for(var i in costars){
    for(var j in costars[i].actors){
      for(var k in characters){
        if(costars[i].actors[j].actor == characters[k].actorName){
          costars[i].actors[j].strangerThingsCharacter = characters[k].characterName;
          costars[i].actors[j].id = k;
        }
      }
    }
  }

  filmsArray = filmsArray.sort(function(a, b) {
    return Object.keys(b.actors).length - Object.keys(a.actors).length;
  });

  console.log(filmsArray);

  $("#list").html("");
  for(i=0; i<filmsArray.length; i++){
    var yearToAdd = "";
    if(filmsArray[i].release_date){
      yearToAdd = " ("+filmsArray[i].release_date+")";
    }
    $("#list").append("<h2><a href='http://www.imdb.com/title/"+filmsArray[i].imdb_id+"' target='_blank'>"+filmsArray[i].title+"</a>"+yearToAdd+"</h2>");
    $.each(filmsArray[i].actors, function(j, value){
      $("#list").append("<li><a href='http://www.imdb.com/name/"+value.id+"' target='_blank'>"+value.actor+"</a> ("+value.strangerThingsCharacter+")</li>");
    });
  }
  
});

    </script>
  </body>
</html>